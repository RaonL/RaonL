- 👋 Hi, I’m @RaonL
- 👀 I’m interested in ...
- 🌱 I’m currently learning ...
- 💞️ I’m looking to collaborate on ...
- 📫 How to reach me ...

port json
import requests, sys, base64, collections
import urllib3
import csv
import getpass

from credential import *




urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


#NITRO_SERVER=input("Server IP: ")

#NITRO_USER=input("Username: ")

#NITRO_PWD = input("pw: ")

NITRO_SERVER= "10.10.11.221"

NITRO_USER= "nsroot"

NITRO_PWD = "N@mu70331"
#USERNAME = "nsroot"
#PASSWORD = "N@mu70331"
#NS_IP = "10.10.10.140"


#.csv 파일을 열고 새 줄을 만듭니다.
with open('monitor_status.csv','w', newline='') as f:
    writer = csv.writer(f)

    # 각 열에 제목 쓰기
    writer.writerow(['vServer Name','Service Name', 'Server Name', 'Port', 'Monitor Name', 'HTTP Request', 'LB VIP Status', 'Server Status', 'Backend Server State'])

    # 로드 밸런싱 vServers 목록을 가져오기 위해 NITRO API에 첫 번째 요청
    lbvs_response=requests.get("http://%s/nitro/v1/config/lbvserver"%(NITRO_SERVER),auth=(NITRO_USER, NITRO_PWD),verify=False)
    
    lbvs_data=json.loads(lbvs_response.text)
    
    # lbvs_data의 각 lbvserver에 대해 이름과 현재 상태를 가져오기
    for j in lbvs_data['lbvserver']:
        lbvs_name=j['name']
        lbvs_stat=j['curstate']

        # 각 부하 분산 vServer에 대한 서비스 그룹 바인딩을 가져오기 위한 요청 보내기
        svg_response=requests.get("http://%s/nitro/v1/config/lbvserver_service_binding/%s"%(NITRO_SERVER,lbvs_name),auth=(NITRO_USER, NITRO_PWD),verify=False)

        svg_data = json.loads(svg_response.text)

        #서비스 그룹 바인딩이 있는 경우 모니터 이름과 서비스 그룹 구성원을 가져오기
        if 'lbvserver_service_binding' in svg_data:
            for k in svg_data['lbvserver_service_binding']:

                svg_grpname=k["servicename"]
                svgmon_response=requests.get("http://%s/nitro/v1/config/service_lbmonitor_binding/%s"%(NITRO_SERVER,svg_grpname),auth=(NITRO_USER, NITRO_PWD),verify=False)
                svgmon_data=json.loads(svgmon_response.text)


            #모니터 바운드가 있는 경우 포트, 백엔드 서버 이름 및 백엔드 서버 상태를 가져오기


                    # 각 모니터에 대해 모니터 이름을 가져
                for m in svgmon_data['service_lbmonitor_binding']:

                        monname=m["monitor_name"]
                        mon_response=requests.get("http://%s/nitro/v1/config/lbmonitor/%s"%(NITRO_SERVER,monname),auth=(NITRO_USER, NITRO_PWD),verify=False)
                        mon_data=json.loads(mon_response.text)

                        for n in mon_data["lbmonitor"]:

                            # http 요청 필드가 있는 경우
                            if 'httprequest' in mon_data["lbmonitor"][0]:

                                httpreq=n['httprequest']
                                mon_sec=n['secure']
                                httpreq=str.replace(httpreq,'GET ','')

                                if( mon_sec == 'NO'):
                                    #create test uri
                                    test_uri='http://'+svrip+svrport+httpreq
                                    response = requests.get(test_uri)

                                    if(response == 200):
                                        backend = 'UP'
                                        writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])
                                    else:
                                        backend = 'DOWN'
                                        writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])
                                else:
                                    test_uri='http://'+svrip+svrport+httpreq
                                    response = requests.get(test_uri)

                                    if(response == 200):
                                        backend = 'UP'
                                        writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])
                                    else:
                                        backend = 'DOWN'
                                        writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])
                                    


                            #else httpreq를 없음에 할당
                            else:

                                httpreq='N/A'
                                backend='N/A'
                                #write to .csv file
                                writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])

            else:

                monname='tcp'
                httpreq='N/A'
                backend='N/A'



        else:
            port ='N/A'
            svrname='N/A'
            httpreq='N/A'
            svg_grpname='N/A'
            monname='N/A'
            svrstate='N/A'
            backend='N/A'
            writer.writerow([lbvs_name,svg_grpname,svrname,port,monname,httpreq,lbvs_stat,svrstate,backend])
